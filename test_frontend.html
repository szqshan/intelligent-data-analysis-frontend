<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库分析系统测试页面</title>
</head>
<body>
    <h1>数据库分析系统 - 接口测试页面</h1>
    
    <!-- 用户信息设置 -->
    <div>
        <h2>1. 用户信息设置</h2>
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
            <strong>⚠️ 重要提醒：</strong> 系统现在仅支持付费用户访问，所有三个字段（用户ID、用户名、API密钥）都是<strong>必需的</strong>。
            <br>请确保提供有效的 Anthropic API Key 以正常使用系统功能。
        </div>
        <label>用户ID: <input type="text" id="userId" value="test_user_001" placeholder="用户ID（必需）"></label><br><br>
        <label>用户名: <input type="text" id="username" value="TestUser" placeholder="用户名（必需）"></label><br><br>
        <label>API密钥: <input type="password" id="apiKey" value="" placeholder="输入您的API密钥（必需）如: sk-ant-api..." style="width: 400px;"></label><br>
        <small style="color: #666; margin-left: 80px;">🔑 API密钥必须有效，用于访问Anthropic Claude服务</small><br><br>
        <button onclick="setUserInfo()">设置用户信息</button>
        <div id="currentUser">当前用户: 未设置</div>
        <div id="apiKeyStatus" style="margin-top: 10px; color: #666;">API密钥状态: 未设置</div>
    </div>

    <hr>

    <!-- 2. 健康检查 -->
    <div>
        <h2>2. 健康检查</h2>
        <button onclick="checkHealth()">检查系统健康状态</button>
        <pre id="healthResult"></pre>
    </div>

    <hr>

    <!-- 3. 系统状态 -->
    <div>
        <h2>3. 系统状态</h2>
        <button onclick="getStatus()">获取系统状态</button>
        <pre id="statusResult"></pre>
    </div>

    <hr>

    <!-- 4. 对话管理功能测试 -->
    <div>
        <h2>4. 对话管理功能测试</h2>
        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
            <div style="flex: 1;">
                <h3>创建新对话</h3>
                <label>对话描述: <input type="text" id="newConversationDesc" placeholder="可选：输入对话描述"></label><br><br>
                <button onclick="createNewConversation()">创建新对话</button>
                <p style="color: #666; font-size: 12px; margin-top: 5px;">💡 对话标题将在您发送第一条消息时由AI自动生成</p>
            </div>
            <div style="flex: 1;">
                <h3>当前对话</h3>
                <button onclick="getCurrentConversation()">获取当前对话</button>
                <button onclick="getConversationsList()">获取对话列表</button>
                <div id="currentConversationInfo" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border: 1px solid #ccc; border-radius: 4px;">
                    未获取当前对话信息
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <h3>对话列表</h3>
            <div id="conversationsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                点击"获取对话列表"查看对话
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <h3>切换对话</h3>
            <label>对话ID: <input type="text" id="switchConversationId" placeholder="输入要切换的对话ID"></label>
            <button onclick="switchConversation()">切换到该对话</button>
        </div>
        
        <pre id="conversationResult" style="background:#f8f8f8; border:1px solid #ccc; padding:10px; min-height:120px;"></pre>
    </div>

    <hr>

    <!-- 5. CSV文件上传 -->
    <div>
        <h2>5. CSV文件上传</h2>
        <input type="file" id="csvFile" accept=".csv"><br><br>
        <button onclick="uploadCSV()">上传CSV文件</button>
        <pre id="uploadResult"></pre>
        
        <h3>当前会话中的数据表</h3>
                    <button onclick="refreshTablesList()" id="refreshTablesBtn">🔄 刷新表列表</button>
            <div id="tablesList" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
                点击"刷新表列表"查看当前会话中的数据表
            </div>
    </div>

    <hr>

    <!-- 6. 流式数据分析 (重点测试) -->
    <div>
        <h2>6. 流式数据分析 (重点测试)</h2>
        <label>分析查询: 
            <textarea id="analysisQuery" rows="3" cols="80" placeholder="输入你的数据分析需求，例如：分析数据的基本统计信息并生成详细的HTML报告">给我个报告</textarea>
        </label><br><br>
        <button onclick="startMultiTurnChat()" id="analyzeBtn">开始多轮对话（包含富文本）</button>
        <button onclick="stopAnalysis()" id="stopBtn" disabled>停止分析</button><br><br>
        
        <h3>流式响应日志:</h3>
        <div style="display: flex; gap: 10px;">
            <div style="flex:1; min-width: 0;">
                <strong>状态(Status)</strong>
                <div id="streamStatusLog" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 5px; font-family: monospace; background: #f5f5f5; font-size: 13px;">等待分析开始...</div>
            </div>
            <div style="flex:1; min-width: 0;">
                <strong>AI回复</strong>
                <div id="streamAIResponseLog" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 5px; font-family: monospace; background: #f5f5f5; font-size: 13px;">等待AI回复...</div>
            </div>
            <div style="flex:1; min-width: 0;">
                <strong>工具结果</strong>
                <div id="streamToolLog" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 5px; font-family: monospace; background: #f5f5f5; font-size: 13px;">无</div>
            </div>
            <div style="flex:1; min-width: 0;">
                <strong>错误/Error</strong>
                <div id="streamErrorLog" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 5px; font-family: monospace; background: #fff0f0; font-size: 13px; color: #b00;">无</div>
            </div>
        </div>
        <div style="margin-top:10px;">
            <strong>全部原始日志</strong>
            <div id="streamLog" style="border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 5px; font-family: monospace; background: #f5f5f5; font-size: 12px;"></div>
        </div>
        
        <h3>多轮对话窗口（打字机效果）:</h3>
        <div id="aiResponse" style="border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; background: #fff;">
            <div style="text-align: center; color: #666; padding: 40px;">
                <p>📱 多轮对话模式</p>
                <p>请在上方输入框中输入您的问题，点击"开始多轮对话"按钮开始聊天</p>
                <p>支持富文本消息和连续对话</p>
            </div>
        </div>


    </div>

    <hr>

    <!-- 7. 历史记录接口测试 -->
    <div>
        <h2>7. 历史记录接口测试</h2>
        <button onclick="getHistoryList()">获取历史列表</button>
        <button onclick="getHistoryStats()">获取统计信息</button>
        <button onclick="getRecentHistory()">获取最近5条</button>
        <br><br>
        <label>对话ID: <input type="text" id="historyDetailId" placeholder="输入对话ID"></label>
        <button onclick="getHistoryDetail()">获取详情</button>
        <button onclick="deleteHistoryDetail()">删除该记录</button>
        <button onclick="loadConversationMessages()">📚 加载此对话到多轮窗口</button>
        <br><br>
        <pre id="historyResult" style="background:#f8f8f8; border:1px solid #ccc; padding:10px; min-height:120px;"></pre>
    </div>

    <!-- 添加必要的库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">

    <style>
        /* 打字机效果样式 */
        .typing-text {
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: #000;
            margin-left: 2px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0; }
        }
        
        /* Markdown 样式 */
        .markdown-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
        }
        
        .markdown-content pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
        }
        
        .markdown-content code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
            background-color: rgba(27, 31, 35, 0.05);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }
        
        .markdown-content p {
            margin: 0 0 16px;
        }
        
        .markdown-content ul, .markdown-content ol {
            padding-left: 2em;
            margin: 0 0 16px;
        }
        
        /* 消息操作按钮样式 */
        .message-actions button {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .message-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .message-actions button:active {
            transform: translateY(0);
        }
        
        /* 消息容器悬停效果 */
        .user-message > div:hover,
        .ai-message > div:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: box-shadow 0.2s ease;
        }
    </style>

    <script>
        // 全局变量
        let currentReader = null;
        let currentUserId = 'test_user_001';
        let currentUsername = 'TestUser';
        let currentApiKey = '';
        // 注意：HTML报告功能已移除，后端不提供 /api/latest-report 接口
        let currentConversationId = null;

        // 设置用户信息
        function setUserInfo() {
            currentUserId = document.getElementById('userId').value || 'test_user_001';
            currentUsername = document.getElementById('username').value || 'TestUser';
            currentApiKey = document.getElementById('apiKey').value || '';
            
            document.getElementById('currentUser').textContent = `当前用户: ${currentUsername} (${currentUserId})`;
            
            // 更新API密钥状态显示
            const apiKeyStatus = document.getElementById('apiKeyStatus');
            if (currentApiKey) {
                const maskedKey = currentApiKey.substring(0, 8) + '***' + currentApiKey.substring(currentApiKey.length - 4);
                apiKeyStatus.textContent = `API密钥状态: 已设置 (${maskedKey})`;
                apiKeyStatus.style.color = '#4CAF50';
            } else {
                apiKeyStatus.textContent = 'API密钥状态: 未设置';
                apiKeyStatus.style.color = '#f44336';
            }
            
            log('用户信息已设置: ' + currentUsername);
        }

        // 获取请求头
        function getHeaders() {
            // 强制要求用户ID、用户名和API Key
            if (!currentUserId || !currentUsername || !currentApiKey) {
                throw new Error('用户ID、用户名和API Key都是必需的');
            }
            
            const headers = {
                'Content-Type': 'application/json',
                'X-User-ID': currentUserId,
                'X-Username': encodeURIComponent(currentUsername),
                'X-API-Key': currentApiKey
            };
            
            return headers;
        }

        // 检查用户认证信息是否完整
        function checkUserAuth() {
            if (!currentUserId) {
                alert('请先设置用户ID！');
                return false;
            }
            if (!currentUsername) {
                alert('请先设置用户名！');
                return false;
            }
            if (!currentApiKey) {
                alert('请先设置API密钥！访问系统需要有效的Anthropic API Key。');
                return false;
            }
            return true;
        }

        // 向后兼容的API Key检查函数
        function checkApiKey() {
            return checkUserAuth();
        }

        // 日志记录函数
        function log(message) {
            console.log(message);
            const logDiv = document.getElementById('streamLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br/>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 分类日志记录函数
        function logByType(type, message) {
            const map = {
                'status': 'streamStatusLog',
                'ai_response': 'streamAIResponseLog',
                'tool_result': 'streamToolLog',
                'error': 'streamErrorLog',
                'html_ready': 'streamStatusLog', // 也归为状态
                'default': 'streamLog'
            };
            const divId = map[type] || map['default'];
            const div = document.getElementById(divId);
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML += `[${timestamp}] ${message}<br/>`;
            div.scrollTop = div.scrollHeight;
        }

        // 清空日志（不清空多轮对话窗口）
        function clearLog() {
            document.getElementById('streamLog').innerHTML = '';
            document.getElementById('streamStatusLog').innerHTML = '';
            document.getElementById('streamAIResponseLog').innerHTML = '';
            document.getElementById('streamToolLog').innerHTML = '';
            document.getElementById('streamErrorLog').innerHTML = '';
        }

        // 1. 健康检查
        async function checkHealth() {
            try {
                log('正在检查系统健康状态...');
                const response = await fetch('http://localhost:5000/api/health');
                const data = await response.json();
                document.getElementById('healthResult').textContent = JSON.stringify(data, null, 2);
                log('健康检查完成');
            } catch (error) {
                log('健康检查失败: ' + error.message);
                document.getElementById('healthResult').textContent = 'Error: ' + error.message;
            }
        }

        // 2. 获取系统状态
        async function getStatus() {
            if (!checkUserAuth()) return;
            
            try {
                log('正在获取系统状态...');
                const response = await fetch('http://localhost:5000/api/status', {
                    method: 'GET',
                    headers: getHeaders()
                });
                const data = await response.json();
                document.getElementById('statusResult').textContent = JSON.stringify(data, null, 2);
                log('系统状态获取完成');
            } catch (error) {
                log('获取系统状态失败: ' + error.message);
                document.getElementById('statusResult').textContent = 'Error: ' + error.message;
            }
        }

        // 3. 上传CSV文件
        async function uploadCSV() {
            if (!checkUserAuth()) return;
            
            const fileInput = document.getElementById('csvFile');
            
            if (!fileInput.files.length) {
                alert('请选择CSV文件');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('userId', currentUserId);
            formData.append('username', currentUsername);

            try {
                log('正在上传CSV文件: ' + file.name);
                
                const uploadHeaders = {
                    'X-User-ID': currentUserId,
                    'X-Username-B64': btoa(unescape(encodeURIComponent(currentUsername))),
                    'X-API-Key': currentApiKey
                };
                
                const response = await fetch('http://localhost:5000/api/upload', {
                    method: 'POST',
                    headers: uploadHeaders,
                    body: formData
                });

                const data = await response.json();
                document.getElementById('uploadResult').textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    log(`CSV上传成功: ${data.data.rows_imported} 行数据已导入`);
                                    // 上传成功后自动刷新表列表
                refreshTablesList();
                } else {
                    log('CSV上传失败: ' + data.message);
                }
            } catch (error) {
                log('CSV上传出错: ' + error.message);
                document.getElementById('uploadResult').textContent = 'Error: ' + error.message;
            }
        }

        // 刷新表列表
        async function refreshTablesList() {
            if (!checkUserAuth()) return;
            
            try {
                log('正在获取表列表...');
                
                const response = await fetch('http://localhost:5000/api/tables-info', {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                
                if (data.success) {
                    displayTablesList(data.data);
                    log(`✅ 获取表列表成功，共 ${data.data.total_tables} 个表`);
                } else {
                    log('❌ 获取表列表失败: ' + data.message);
                    document.getElementById('tablesList').innerHTML = '<p style="color: red;">获取表列表失败: ' + data.message + '</p>';
                }
            } catch (error) {
                log('❌ 获取表列表出错: ' + error.message);
                document.getElementById('tablesList').innerHTML = '<p style="color: red;">获取表列表出错: ' + error.message + '</p>';
            }
        }

        // 显示表列表（增强版 - 支持详细表结构信息）
        function displayTablesList(data) {
            const tablesDiv = document.getElementById('tablesList');
            
            // 添加调试信息
            console.log('displayTablesList 接收到的数据:', data);
            console.log('data.tables 类型:', typeof data.tables);
            console.log('data.tables 是否为数组:', Array.isArray(data.tables));
            
            if (!data.tables || !Array.isArray(data.tables) || data.tables.length === 0) {
                tablesDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">当前会话中没有数据表<br>请先上传文件</p>';
                return;
            }
            
            let html = '<div>';
            html += `<p><strong>当前会话中共有 ${data.tables.length} 个数据表:</strong></p>`;
            html += `<p><small>数据库路径: ${data.database_path}</small></p>`;
            
            data.tables.forEach((table, index) => {
                html += `
                    <div style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            📊 表 ${index + 1}: ${table.table_name}
                        </h4>
                        <div style="margin-left: 10px; color: #666; font-size: 14px;">
                            <p><strong>📁 原始文件:</strong> ${table.original_filename}</p>
                            <p><strong>📏 数据规模:</strong> ${table.row_count} 行 × ${table.columns.length} 列</p>
                            <p><strong>🕒 创建时间:</strong> ${table.created_at}</p>
                            <p><strong>📝 描述:</strong> ${table.description}</p>
                            
                            <!-- 列结构信息 -->
                            <div style="margin-top: 10px;">
                                <strong>🏗️ 列结构:</strong>
                                <div style="margin-left: 15px; max-height: 150px; overflow-y: auto; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 5px;">
                `;
                
                table.columns.forEach((col, colIndex) => {
                    html += `<span style="display: inline-block; margin: 2px 8px 2px 0; padding: 2px 6px; background: #e9ecef; border-radius: 3px; font-size: 12px;">${col.name} (${col.type})</span>`;
                });
                
                html += `
                                </div>
                            </div>
                            
                            <!-- 样本数据 -->
                            ${table.sample_data && table.sample_data.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong>📋 样本数据 (前3行):</strong>
                                <div style="margin-top: 5px; font-size: 12px; background: #f8f9fa; padding: 8px; border-radius: 4px; overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; min-width: 400px;">
                                        <thead>
                                            <tr style="background: #e9ecef;">
                                                ${table.columns.map(col => `<th style="border: 1px solid #ddd; padding: 4px; text-align: left;">${col.name}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${table.sample_data.map(row => `
                                                <tr>
                                                    ${table.columns.map(col => `<td style="border: 1px solid #ddd; padding: 4px; max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${row[col.name] || ''}</td>`).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            tablesDiv.innerHTML = html;
        }

        // 配置 marked
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // 打字机效果类
        class TypingText {
            constructor(element, options = {}) {
                this.element = element;
                this.options = {
                    speed: options.speed || 30,
                    cursor: options.cursor !== false,
                    onComplete: options.onComplete || (() => {})
                };
                
                this.queue = [];
                this.isTyping = false;
                this.currentText = '';
                
                if (this.options.cursor) {
                    this.cursor = document.createElement('span');
                    this.cursor.className = 'typing-cursor';
                    this.element.appendChild(this.cursor);
                }
            }
            
            type(text) {
                this.queue.push(text);
                if (!this.isTyping) {
                    this.startTyping();
                }
            }
            
            async startTyping() {
                this.isTyping = true;
                
                while (this.queue.length > 0) {
                    const text = this.queue.shift();
                    await this.typeText(text);
                }
                
                this.isTyping = false;
                this.options.onComplete();
            }
            
            async typeText(text) {
                const words = text.split(/(\s+)/);
                
                for (const word of words) {
                    this.currentText += word;
                    this.element.innerHTML = marked.parse(this.currentText);
                    if (this.options.cursor) {
                        this.element.appendChild(this.cursor);
                    }
                    await new Promise(resolve => setTimeout(resolve, this.options.speed));
                }
            }
            
            skip() {
                this.queue = [];
                if (this.isTyping) {
                    this.isTyping = false;
                    this.currentText += this.queue.join('');
                    this.element.innerHTML = marked.parse(this.currentText);
                    if (this.options.cursor) {
                        this.element.appendChild(this.cursor);
                    }
                    this.options.onComplete();
                }
            }
        }

        // 4. 开始多轮对话（包含富文本）
        async function startMultiTurnChat() {
            if (!checkUserAuth()) return;
            
            const query = document.getElementById('analysisQuery').value.trim();
            if (!query) {
                alert('请输入您的问题或需求');
                return;
            }
            
            // 如果没有当前对话，先创建一个
            if (!currentConversationId) {
                await createNewConversation();
            }

            // 不清空任何内容，保持日志和对话历史
            
            // 更新按钮状态
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            log('=== 开始多轮对话 ===');
            log('用户消息: ' + query);
            
            // 在多轮对话窗口中显示用户消息
            addUserMessageToChat(query);
            
            // 重置AI消息状态，准备接收新的AI回复
            const aiDiv = document.getElementById('aiResponse');
            aiDiv.currentAIMessage = null;
            aiDiv.typingText = null;

            try {
                // 🔥 关键修复：使用正确的流式请求方式
                const streamHeaders = {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream',
                    'Cache-Control': 'no-cache',
                    'X-User-ID': currentUserId,
                    'X-Username': encodeURIComponent(currentUsername),
                    'X-API-Key': currentApiKey
                };
                
                const response = await fetch('http://localhost:5000/api/analyze-stream', {
                    method: 'POST',
                    headers: streamHeaders,
                                    body: JSON.stringify({ 
                    query: query,
                    userId: currentUserId,
                    username: currentUsername,
                    conversation_id: currentConversationId
                })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // 🔥 关键修复：使用ReadableStream正确处理流式数据
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                currentReader = reader;
                let buffer = '';

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            log('=== 多轮对话回复完成 ===');
                            break;
                        }
                        
                        // 解码数据块
                        buffer += decoder.decode(value, { stream: true });
                        
                        // 按行处理数据
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // 保留最后一个不完整的行
                        
                        for (const line of lines) {
                            const trimmedLine = line.trim();
                            
                            if (trimmedLine === '') {
                                continue; // 跳过空行
                            }
                            
                            // 🔥 处理Server-Sent Events格式
                            if (trimmedLine.startsWith('data: ')) {
                                try {
                                    const jsonStr = trimmedLine.slice(6); // 移除 'data: '
                                    
                                    if (jsonStr === '[DONE]') {
                                        log('收到完成信号');
                                        break;
                                    }
                                    
                                    const data = JSON.parse(jsonStr);
                                    handleStreamMessage(data);
                                    
                                } catch (parseError) {
                                    log('解析流数据失败: ' + trimmedLine);
                                    console.error('Parse error:', parseError);
                                }
                            }
                        }
                    }
                } finally {
                    if (currentReader) {
                        currentReader.releaseLock();
                        currentReader = null;
                    }
                }

            } catch (error) {
                log('多轮对话出错: ' + error.message);
                console.error('Stream error:', error);
            } finally {
                // 恢复按钮状态
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                
                // 清空输入框，准备下一轮对话
                document.getElementById('analysisQuery').value = '';
            }
        }

        // 修改处理流式消息的函数
        function handleStreamMessage(data) {
            const type = data.type;
            
            switch (type) {
                case 'status':
                    logByType('status', data.message);
                    log(`[状态] ${data.message}`);
                    break;
                    
                case 'ai_response':
                    const aiDiv = document.getElementById('aiResponse');
                    // 检查是否是新的AI回复（每次发送消息时都需要创建新的AI消息框）
                    if (!aiDiv.currentAIMessage) {
                        // 创建新的AI消息
                        addAIMessageToChat('');
                        aiDiv.currentAIMessage = aiDiv.querySelector('.ai-message:last-child .message-content');
                        aiDiv.typingText = new TypingText(aiDiv.currentAIMessage, {
                            speed: 20,
                            cursor: true,
                            onComplete: () => {
                                aiDiv.scrollTop = aiDiv.scrollHeight;
                                // 不要立即清空，等待下次新消息时再创建
                            }
                        });
                    }
                    aiDiv.typingText.type(data.content);
                    logByType('ai_response', data.content);
                    log(`[AI回复] 收到 ${data.content.length} 字符`);
                    break;
                    
                case 'tool_result':
                    logByType('tool_result', `${data.tool}: ${JSON.stringify(data.result).substring(0, 200)}...`);
                    log(`[工具结果] ${data.tool}: ${JSON.stringify(data.result).substring(0, 200)}...`);
                    break;
                    
                case 'html_ready':
                    logByType('status', `[HTML就绪] 报告文件: ${data.file_path}`);
                    log(`[HTML就绪] 报告文件: ${data.file_path}`);
                    setTimeout(() => {
                        getLatestReport();
                    }, 1000);
                    break;
                    
                case 'error':
                    logByType('error', data.message);
                    log(`[错误] ${data.message}`);
                    break;
                    
                case 'user_message_id':
                    // 更新最后一条用户消息的ID
                    const tempUserMessage = document.querySelector('[data-message-id="temp"].user-message');
                    if (tempUserMessage) {
                        tempUserMessage.setAttribute('data-message-id', data.message_id);
                        // 添加操作按钮
                        const messageContainer = tempUserMessage.querySelector('div');
                        const actionsHTML = `
                            <div class="message-actions" style="position: absolute; top: -8px; right: -8px; display: none; flex-direction: row; gap: 4px;">
                                <button onclick="editMessage('${data.message_id}', 'user')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #007bff; border: 1px solid #007bff; border-radius: 4px; cursor: pointer;" title="编辑消息">✏️</button>
                                <button onclick="deleteMessage('${data.message_id}')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; cursor: pointer;" title="撤销消息">🗑️</button>
                            </div>
                        `;
                        messageContainer.insertAdjacentHTML('beforeend', actionsHTML);
                        
                        // 添加鼠标悬停事件
                        const actionsDiv = messageContainer.querySelector('.message-actions');
                        messageContainer.addEventListener('mouseenter', () => {
                            actionsDiv.style.display = 'flex';
                        });
                        messageContainer.addEventListener('mouseleave', () => {
                            actionsDiv.style.display = 'none';
                        });
                    }
                    log(`[消息ID] 用户消息ID: ${data.message_id}`);
                    break;
                    
                case 'ai_message_id':
                    // 更新最后一条AI消息的ID
                    const tempAIMessage = document.querySelector('[data-message-id="temp"].ai-message');
                    if (tempAIMessage) {
                        tempAIMessage.setAttribute('data-message-id', data.message_id);
                        // 添加操作按钮
                        const messageContainer = tempAIMessage.querySelector('div');
                        const actionsHTML = `
                            <div class="message-actions" style="position: absolute; top: -8px; right: -8px; display: none; flex-direction: row; gap: 4px;">
                                <button onclick="editMessage('${data.message_id}', 'assistant')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #28a745; border: 1px solid #28a745; border-radius: 4px; cursor: pointer;" title="编辑消息">✏️</button>
                                <button onclick="deleteMessage('${data.message_id}')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; cursor: pointer;" title="撤销消息">🗑️</button>
                            </div>
                        `;
                        messageContainer.insertAdjacentHTML('beforeend', actionsHTML);
                        
                        // 添加鼠标悬停事件
                        const actionsDiv = messageContainer.querySelector('.message-actions');
                        messageContainer.addEventListener('mouseenter', () => {
                            actionsDiv.style.display = 'flex';
                        });
                        messageContainer.addEventListener('mouseleave', () => {
                            actionsDiv.style.display = 'none';
                        });
                    }
                    log(`[消息ID] AI消息ID: ${data.message_id}`);
                    break;
                    
                default:
                    logByType('default', JSON.stringify(data));
                    log(`[未知消息] ${JSON.stringify(data)}`);
            }
        }

        // 清空多轮对话窗口
        function clearMultiTurnChatWindow() {
            const chatDiv = document.getElementById('aiResponse');
            chatDiv.innerHTML = `
                <div style="text-align: center; color: #666; padding: 40px;">
                    <p>📱 多轮对话模式</p>
                    <p>请在上方输入框中输入您的问题，点击"开始多轮对话"按钮开始聊天</p>
                    <p>支持富文本消息和连续对话</p>
                </div>
            `;
            // 重置状态
            chatDiv.currentAIMessage = null;
            chatDiv.typingText = null;
        }

        // 添加用户消息到多轮对话窗口
        function addUserMessageToChat(message, messageId = null) {
            const chatDiv = document.getElementById('aiResponse');
            
            // 如果是第一条消息，清空欢迎信息
            if (chatDiv.innerHTML.includes('多轮对话模式')) {
                chatDiv.innerHTML = '';
            }
            
            const userDiv = document.createElement('div');
            userDiv.className = 'user-message';
            userDiv.style.marginBottom = '16px';
            userDiv.style.display = 'flex';
            userDiv.style.justifyContent = 'flex-end';
            userDiv.setAttribute('data-message-id', messageId || 'temp');
            
            userDiv.innerHTML = `
                <div style="max-width: 70%; padding: 12px 16px; background: #007bff; color: white; border-radius: 18px 18px 4px 18px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; group;">
                    <div style="font-weight: 600; margin-bottom: 4px;">👤 我</div>
                    <div class="message-text" style="white-space: pre-wrap;">${message}</div>
                    ${messageId ? `
                    <div class="message-actions" style="position: absolute; top: -8px; right: -8px; display: none; flex-direction: row; gap: 4px;">
                        <button onclick="editMessage('${messageId}', 'user')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #007bff; border: 1px solid #007bff; border-radius: 4px; cursor: pointer;" title="编辑消息">✏️</button>
                        <button onclick="deleteMessage('${messageId}')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; cursor: pointer;" title="撤销消息">🗑️</button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // 添加鼠标悬停事件
            if (messageId) {
                const messageContainer = userDiv.querySelector('div');
                const actionsDiv = userDiv.querySelector('.message-actions');
                
                messageContainer.addEventListener('mouseenter', () => {
                    actionsDiv.style.display = 'flex';
                });
                messageContainer.addEventListener('mouseleave', () => {
                    actionsDiv.style.display = 'none';
                });
            }
            
            chatDiv.appendChild(userDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        
        // 添加AI消息到多轮对话窗口
        function addAIMessageToChat(content, messageId = null) {
            const chatDiv = document.getElementById('aiResponse');
            
            const aiDiv = document.createElement('div');
            aiDiv.className = 'ai-message';
            aiDiv.style.marginBottom = '16px';
            aiDiv.style.display = 'flex';
            aiDiv.style.justifyContent = 'flex-start';
            aiDiv.setAttribute('data-message-id', messageId || 'temp');
            
            aiDiv.innerHTML = `
                <div style="max-width: 70%; padding: 12px 16px; background: #f1f3f4; color: #333; border-radius: 18px 18px 18px 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative;">
                    <div style="font-weight: 600; margin-bottom: 4px;">🤖 AI助手</div>
                    <div class="message-content" style="white-space: pre-wrap;">${content}</div>
                    ${messageId ? `
                    <div class="message-actions" style="position: absolute; top: -8px; right: -8px; display: none; flex-direction: row; gap: 4px;">
                        <button onclick="editMessage('${messageId}', 'assistant')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #28a745; border: 1px solid #28a745; border-radius: 4px; cursor: pointer;" title="编辑消息">✏️</button>
                        <button onclick="deleteMessage('${messageId}')" style="padding: 4px 6px; font-size: 10px; background: #fff; color: #dc3545; border: 1px solid #dc3545; border-radius: 4px; cursor: pointer;" title="撤销消息">🗑️</button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // 添加鼠标悬停事件
            if (messageId) {
                const messageContainer = aiDiv.querySelector('div');
                const actionsDiv = aiDiv.querySelector('.message-actions');
                
                messageContainer.addEventListener('mouseenter', () => {
                    actionsDiv.style.display = 'flex';
                });
                messageContainer.addEventListener('mouseleave', () => {
                    actionsDiv.style.display = 'none';
                });
            }
            
            chatDiv.appendChild(aiDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        // 从消息内容中提取文本
        function extractTextContent(content) {
            if (typeof content === 'string') {
                return content;
            }
            if (Array.isArray(content)) {
                let text = '';
                content.forEach(block => {
                    if (block.type === 'text') {
                        text += block.text;
                    } else if (block.type === 'tool_use') {
                        text += `[使用工具: ${block.name}]`;
                    } else if (block.type === 'tool_result') {
                        text += `[工具结果]`;
                    }
                });
                return text;
            }
            return String(content);
        }

        // 渲染历史消息到多轮对话窗口
        function renderHistoryMessages(messages) {
            if (!messages || messages.length === 0) {
                log('📚 当前对话暂无历史消息');
                return;
            }
            
            log(`📚 正在加载 ${messages.length} 条历史消息...`);
            
            // 清空窗口
            const chatDiv = document.getElementById('aiResponse');
            chatDiv.innerHTML = '';
            
            // 渲染每条消息
            messages.forEach((msg, index) => {
                if (msg.role === 'user') {
                    const textContent = extractTextContent(msg.content);
                    if (textContent.trim()) {
                        addUserMessageToChat(textContent, msg.id);
                    }
                } else if (msg.role === 'assistant') {
                    const textContent = extractTextContent(msg.content);
                    if (textContent.trim()) {
                        addAIMessageToChat(textContent, msg.id);
                    }
                }
                // 跳过tool_result消息，因为它们通常包含在assistant消息中
            });
            
            // 滚动到底部
            chatDiv.scrollTop = chatDiv.scrollHeight;
            
            log(`✅ 历史消息加载完成，共显示 ${messages.length} 条消息`);
        }

        // 停止分析
        function stopAnalysis() {
            if (currentReader) {
                currentReader.cancel();
                currentReader = null;
            }
            log('分析已停止');
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        // 注意：HTML报告功能已移除，后端不提供 /api/latest-report 接口
        // 用户可以通过AI分析直接生成和查看报告

        // 页面加载完成后设置默认用户信息
        window.addEventListener('load', function() {
            setUserInfo();
            log('测试页面已加载完成');
            
            // 自动进行连接测试
            setTimeout(() => {
                checkHealth();
            }, 500);
        });

        // 🔥 添加全局错误处理
        window.addEventListener('unhandledrejection', event => {
            console.error('未处理的Promise拒绝:', event.reason);
            log('全局错误: ' + event.reason);
        });

        window.addEventListener('error', event => {
            console.error('全局错误:', event.error);
            log('JavaScript错误: ' + event.error);
        });

        // 历史记录相关API
        async function getHistoryList() {
            const limit = 10, offset = 0;
            const response = await fetch(`http://localhost:5000/api/conversations?limit=${limit}&offset=${offset}`, {
                method: 'GET',
                headers: getHeaders()
            });
            const data = await response.json();
            document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
        }
        async function getHistoryStats() {
            const response = await fetch('http://localhost:5000/api/conversations/stats', {
                method: 'GET',
                headers: getHeaders()
            });
            const data = await response.json();
            document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
        }
        async function getRecentHistory() {
            const response = await fetch('http://localhost:5000/api/conversations/recent?limit=5', {
                method: 'GET',
                headers: getHeaders()
            });
            const data = await response.json();
            document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
        }
        async function getHistoryDetail() {
            const id = document.getElementById('historyDetailId').value.trim();
            if (!id) { alert('请输入对话ID'); return; }
            const response = await fetch(`http://localhost:5000/api/conversations/${id}`, {
                method: 'GET',
                headers: getHeaders()
            });
            const data = await response.json();
            document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
        }
        async function deleteHistoryDetail() {
            const id = document.getElementById('historyDetailId').value.trim();
            if (!id) { alert('请输入对话ID'); return; }
            if (!confirm('确定要删除该对话记录吗？')) return;
            const response = await fetch(`http://localhost:5000/api/conversations/${id}`, {
                method: 'DELETE',
                headers: getHeaders()
            });
            const data = await response.json();
            document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
        }

        // 对话管理相关API
        async function createNewConversation() {
            try {
                const description = document.getElementById('newConversationDesc').value.trim();
                const response = await fetch('http://localhost:5000/api/conversations/create', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        description: description || undefined
                    })
                });
                const data = await response.json();
                document.getElementById('conversationResult').textContent = JSON.stringify(data, null, 2);
                if (data.success) {
                    currentConversationId = data.conversation.conversation_id;
                    log('新对话创建成功: ' + data.conversation.conversation_name);
                    
                    // 清空多轮对话窗口，显示新对话的欢迎信息
                    clearMultiTurnChatWindow();
                    
                    getConversationsList();
                    getCurrentConversation();
                } else {
                    log('创建对话失败: ' + data.message);
                }
            } catch (error) {
                log('创建对话出错: ' + error.message);
                document.getElementById('conversationResult').textContent = 'Error: ' + error.message;
            }
        }

        async function getConversationsList() {
            try {
                const response = await fetch('http://localhost:5000/api/conversations/list', {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                document.getElementById('conversationResult').textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    // 更新对话列表显示
                    const listDiv = document.getElementById('conversationsList');
                    if (data.conversations && data.conversations.length > 0) {
                        let html = '<div style="font-weight: bold; margin-bottom: 10px;">对话列表:</div>';
                        data.conversations.forEach(conv => {
                            const isCurrent = conv.conversation_id === data.current_conversation_id;
                            html += `
                                <div style="margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: ${isCurrent ? '#e6f3ff' : '#fff'};">
                                    <div><strong>${conv.conversation_name}</strong> ${isCurrent ? '(当前)' : ''}</div>
                                    <div style="font-size: 12px; color: #666;">ID: ${conv.conversation_id}</div>
                                    <div style="font-size: 12px; color: #666;">描述: ${conv.description || '无'}</div>
                                    <div style="font-size: 12px; color: #666;">创建时间: ${conv.created_time}</div>
                                    <div style="font-size: 12px; color: #666;">消息数: ${conv.message_count}</div>
                                    <button onclick="switchToConversation('${conv.conversation_id}')" style="margin-top: 5px; padding: 2px 8px; font-size: 11px;">切换到此对话</button>
                                    <button onclick="loadConversationToChat('${conv.conversation_id}')" style="margin-top: 5px; margin-left: 5px; padding: 2px 8px; font-size: 11px; background-color: #4CAF50; color: white; border: none; border-radius: 3px;">📚 加载到聊天</button>
                                    <button onclick="deleteConversation('${conv.conversation_id}', '${conv.conversation_name}')" style="margin-top: 5px; margin-left: 5px; padding: 2px 8px; font-size: 11px; background-color: #ff4444; color: white; border: none; border-radius: 3px;">删除</button>
                                </div>
                            `;
                        });
                        listDiv.innerHTML = html;
                    } else {
                        listDiv.innerHTML = '暂无对话';
                    }
                    
                    log('对话列表获取成功，共 ' + (data.conversations ? data.conversations.length : 0) + ' 个对话');
                } else {
                    log('获取对话列表失败: ' + data.message);
                }
            } catch (error) {
                log('获取对话列表出错: ' + error.message);
                document.getElementById('conversationResult').textContent = 'Error: ' + error.message;
            }
        }

        async function getCurrentConversation() {
            try {
                const response = await fetch('http://localhost:5000/api/conversations/current', {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                document.getElementById('conversationResult').textContent = JSON.stringify(data, null, 2);
                
                if (data.success && data.current_conversation) {
                    const conv = data.current_conversation;
                    currentConversationId = conv.conversation_id;
                    const infoDiv = document.getElementById('currentConversationInfo');
                    infoDiv.innerHTML = `
                        <div><strong>当前对话:</strong> ${conv.conversation_name}</div>
                        <div><strong>对话ID:</strong> ${conv.conversation_id}</div>
                        <div><strong>描述:</strong> ${conv.description || '无'}</div>
                        <div><strong>创建时间:</strong> ${conv.created_time}</div>
                        <div><strong>最后活动:</strong> ${conv.last_activity}</div>
                        <div><strong>消息数:</strong> ${conv.message_count}</div>
                    `;
                    
                    // 加载历史消息到多轮对话窗口
                    if (conv.messages) {
                        renderHistoryMessages(conv.messages);
                    } else {
                        clearMultiTurnChatWindow();
                    }
                    
                    log('当前对话信息获取成功: ' + conv.conversation_name);
                } else {
                    document.getElementById('currentConversationInfo').innerHTML = '未获取到当前对话信息';
                    log('获取当前对话失败: ' + (data.message || '未知错误'));
                }
            } catch (error) {
                log('获取当前对话出错: ' + error.message);
                document.getElementById('conversationResult').textContent = 'Error: ' + error.message;
            }
        }

        async function switchConversation() {
            try {
                const conversationId = document.getElementById('switchConversationId').value.trim();
                if (!conversationId) {
                    alert('请输入对话ID');
                    return;
                }
                const response = await fetch('http://localhost:5000/api/conversations/switch', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        conversation_id: conversationId
                    })
                });
                const data = await response.json();
                document.getElementById('conversationResult').textContent = JSON.stringify(data, null, 2);
                if (data.success) {
                    currentConversationId = data.current_conversation.conversation_id;
                    log('对话切换成功: ' + data.current_conversation.conversation_name);
                    
                    // 加载历史消息到多轮对话窗口
                    if (data.current_conversation.messages) {
                        renderHistoryMessages(data.current_conversation.messages);
                    } else {
                        clearMultiTurnChatWindow();
                    }
                    
                    getCurrentConversation();
                    getConversationsList();
                } else {
                    log('对话切换失败: ' + data.message);
                }
            } catch (error) {
                log('切换对话出错: ' + error.message);
                document.getElementById('conversationResult').textContent = 'Error: ' + error.message;
            }
        }

        // 便捷切换对话函数
        function switchToConversation(conversationId) {
            document.getElementById('switchConversationId').value = conversationId;
            switchConversation();
        }

        // 加载对话消息到多轮对话窗口
        async function loadConversationToChat(conversationId) {
            try {
                log(`📚 正在加载对话 ${conversationId} 的历史消息...`);
                
                const response = await fetch(`http://localhost:5000/api/conversations/${conversationId}`, {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (data.success && data.conversation && data.conversation.messages) {
                    renderHistoryMessages(data.conversation.messages);
                    log(`✅ 对话历史加载成功，共 ${data.conversation.messages.length} 条消息`);
                    
                    // 更新当前对话ID
                    currentConversationId = conversationId;
                    
                    // 滚动到多轮对话窗口
                    document.getElementById('aiResponse').scrollIntoView({ behavior: 'smooth' });
                } else {
                    log('❌ 加载对话历史失败: ' + (data.message || '对话数据为空'));
                    alert('加载对话历史失败: ' + (data.message || '对话数据为空'));
                }
            } catch (error) {
                log('❌ 加载对话历史出错: ' + error.message);
                alert('加载对话历史出错: ' + error.message);
            }
        }

        // 删除对话函数
        async function deleteConversation(conversationId, conversationName) {
            try {
                if (!confirm(`确定要删除对话"${conversationName}"吗？此操作无法撤销！`)) {
                    return;
                }
                
                const response = await fetch(`http://localhost:5000/api/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`对话"${conversationName}"删除成功`);
                    // 刷新对话列表
                    getConversationsList();
                    // 刷新当前对话信息
                    getCurrentConversation();
                } else {
                    alert('删除失败: ' + data.message);
                    log('删除对话失败: ' + data.message);
                }
            } catch (error) {
                alert('删除对话出错: ' + error.message);
                log('删除对话出错: ' + error.message);
            }
        }

        // 编辑消息函数
        async function editMessage(messageId, role) {
            try {
                if (!currentConversationId) {
                    alert('请先选择一个对话');
                    return;
                }
                
                // 获取当前消息内容
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (!messageElement) {
                    alert('找不到要编辑的消息');
                    return;
                }
                
                const currentText = messageElement.querySelector('.message-text, .message-content').textContent;
                
                // 弹出编辑对话框
                const newContent = prompt('编辑消息内容:', currentText);
                if (newContent === null || newContent.trim() === '') {
                    return; // 用户取消或输入为空
                }
                
                if (newContent === currentText) {
                    return; // 内容未变化
                }
                
                log(`📝 正在编辑消息 ${messageId}...`);
                
                // 发送编辑请求
                const response = await fetch(`http://localhost:5000/api/conversations/${currentConversationId}/messages/${messageId}/edit`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        new_content: newContent
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`✅ 消息编辑成功`);
                    
                    // 更新前端显示
                    const textElement = messageElement.querySelector('.message-text, .message-content');
                    textElement.textContent = newContent;
                    
                    // 刷新当前对话信息
                    getCurrentConversation();
                } else {
                    alert('编辑消息失败: ' + data.message);
                    log('编辑消息失败: ' + data.message);
                }
            } catch (error) {
                alert('编辑消息出错: ' + error.message);
                log('编辑消息出错: ' + error.message);
            }
        }

        // 删除消息函数
        async function deleteMessage(messageId) {
            try {
                if (!currentConversationId) {
                    alert('请先选择一个对话');
                    return;
                }
                
                if (!confirm('确定要撤销这条消息吗？此操作无法撤销！')) {
                    return;
                }
                
                log(`🗑️ 正在删除消息 ${messageId}...`);
                
                // 发送删除请求
                const response = await fetch(`http://localhost:5000/api/conversations/${currentConversationId}/messages/${messageId}/delete`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`✅ 消息删除成功`);
                    
                    // 从前端移除消息
                    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageElement) {
                        messageElement.remove();
                    }
                    
                    // 刷新当前对话信息
                    getCurrentConversation();
                } else {
                    alert('删除消息失败: ' + data.message);
                    log('删除消息失败: ' + data.message);
                }
            } catch (error) {
                alert('删除消息出错: ' + error.message);
                log('删除消息出错: ' + error.message);
            }
        }

        // 历史记录测试区域的加载对话消息功能
        async function loadConversationMessages() {
            const conversationId = document.getElementById('historyDetailId').value.trim();
            if (!conversationId) {
                alert('请先输入对话ID');
                return;
            }
            
            try {
                log(`📚 正在从历史记录加载对话 ${conversationId}...`);
                
                const response = await fetch(`http://localhost:5000/api/conversations/${conversationId}`, {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (data.success && data.conversation) {
                    // 显示对话详情到历史记录结果区域
                    document.getElementById('historyResult').textContent = JSON.stringify(data.conversation, null, 2);
                    
                    // 如果有消息，加载到多轮对话窗口
                    if (data.conversation.messages && data.conversation.messages.length > 0) {
                        renderHistoryMessages(data.conversation.messages);
                        log(`✅ 对话历史加载成功，共 ${data.conversation.messages.length} 条消息`);
                        
                        // 更新当前对话ID
                        currentConversationId = conversationId;
                        
                        // 滚动到多轮对话窗口
                        document.getElementById('aiResponse').scrollIntoView({ behavior: 'smooth' });
                        
                        alert(`对话历史加载成功！\n对话名称: ${data.conversation.conversation_name}\n消息数量: ${data.conversation.messages.length} 条\n\n已加载到多轮对话窗口，请向下滚动查看。`);
                    } else {
                        log('⚠️ 该对话没有消息记录');
                        alert('该对话没有消息记录');
                    }
                } else {
                    log('❌ 加载对话失败: ' + (data.message || '对话不存在'));
                    alert('加载对话失败: ' + (data.message || '对话不存在'));
                }
            } catch (error) {
                log('❌ 加载对话出错: ' + error.message);
                alert('加载对话出错: ' + error.message);
            }
        }

        // 渲染历史消息到多轮对话窗口
        function renderHistoryMessages(messages) {
            const aiDiv = document.getElementById('aiResponse');
            
            // 清空现有内容
            aiDiv.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                aiDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">该对话没有消息记录</div>';
                return;
            }
            
            // 添加历史记录标识
            const historyHeader = document.createElement('div');
            historyHeader.style.cssText = 'text-align: center; padding: 10px; background: #f0f8ff; border: 1px solid #ccc; margin-bottom: 10px; border-radius: 4px; color: #666;';
            historyHeader.innerHTML = `📚 历史对话记录 (共 ${messages.length} 条消息)`;
            aiDiv.appendChild(historyHeader);
            
            // 渲染每条消息
            messages.forEach((message, index) => {
                const messageDiv = renderSingleMessage(message, index);
                aiDiv.appendChild(messageDiv);
            });
            
            // 滚动到底部
            aiDiv.scrollTop = aiDiv.scrollHeight;
        }

        // 渲染单条消息
        function renderSingleMessage(message, index) {
            const messageDiv = document.createElement('div');
            messageDiv.setAttribute('data-message-id', message.id);
            messageDiv.style.cssText = 'margin-bottom: 15px; padding: 12px; border-radius: 8px; border: 1px solid #ddd;';
            
            // 判断消息类型
            const messageType = getMessageDisplayType(message);
            
            // 根据消息类型设置样式和内容
            switch(messageType) {
                case 'user-input':
                    messageDiv.className = 'user-message';
                    messageDiv.style.backgroundColor = '#e3f2fd';
                    messageDiv.style.marginLeft = '20%';
                    messageDiv.innerHTML = `
                        <div style="font-weight: bold; color: #1976d2; margin-bottom: 5px;">👤 用户</div>
                        <div class="message-content">${renderMessageContent(message.content)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">${formatTimestamp(message.timestamp)}</div>
                    `;
                    break;
                    
                case 'ai-response':
                case 'ai-with-tools':
                case 'ai-tool-only':
                    messageDiv.className = 'ai-message';
                    messageDiv.style.backgroundColor = '#f5f5f5';
                    messageDiv.style.marginRight = '20%';
                    messageDiv.innerHTML = `
                        <div style="font-weight: bold; color: #4caf50; margin-bottom: 5px;">🤖 AI助手</div>
                        <div class="message-content">${renderMessageContent(message.content)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">${formatTimestamp(message.timestamp)}</div>
                    `;
                    break;
                    
                case 'tool-result':
                    messageDiv.className = 'tool-result-message';
                    messageDiv.style.backgroundColor = '#e8f5e8';
                    messageDiv.style.margin = '0 10%';
                    messageDiv.style.border = '1px dashed #4caf50';
                    messageDiv.innerHTML = `
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">⚙️ 工具执行结果</div>
                        <div class="message-content" style="font-family: monospace; font-size: 13px;">${renderMessageContent(message.content)}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">${formatTimestamp(message.timestamp)}</div>
                    `;
                    break;
            }
            
            return messageDiv;
        }

        // 判断消息显示类型
        function getMessageDisplayType(message) {
            if (message.role === 'user') {
                const hasToolResult = message.content.some(c => c.type === 'tool_result');
                return hasToolResult ? 'tool-result' : 'user-input';
            } else if (message.role === 'assistant') {
                const hasToolUse = message.content.some(c => c.type === 'tool_use');
                const hasText = message.content.some(c => c.type === 'text');
                
                if (hasToolUse && hasText) {
                    return 'ai-with-tools';
                } else if (hasToolUse) {
                    return 'ai-tool-only';
                } else {
                    return 'ai-response';
                }
            }
            return 'unknown';
        }

        // 渲染消息内容
        function renderMessageContent(contentArray) {
            if (!Array.isArray(contentArray)) {
                return '<div>消息格式错误</div>';
            }
            
            return contentArray.map(item => {
                switch(item.type) {
                    case 'text':
                        return `<div class="text-content">${marked.parse(item.text)}</div>`;
                        
                    case 'tool_use':
                        return `
                            <div class="tool-call" style="background: #fff3cd; padding: 8px; border-radius: 4px; margin: 5px 0;">
                                <div style="font-weight: bold; color: #856404;">🔧 调用工具: ${item.name}</div>
                                <pre style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 5px;">${JSON.stringify(item.input, null, 2)}</pre>
                            </div>
                        `;
                        
                    case 'tool_result':
                        let resultContent = item.content;
                        if (typeof resultContent === 'object') {
                            resultContent = JSON.stringify(resultContent, null, 2);
                        }
                        return `
                            <div class="tool-result" style="background: #d1ecf1; padding: 8px; border-radius: 4px; margin: 5px 0;">
                                <div style="font-weight: bold; color: #0c5460;">📊 执行结果:</div>
                                <pre style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 5px; white-space: pre-wrap;">${resultContent}</pre>
                            </div>
                        `;
                        
                    default:
                        return `<div>未知内容类型: ${item.type}</div>`;
                }
            }).join('');
        }

        // 格式化时间戳
        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('zh-CN');
            } catch (error) {
                return timestamp;
            }
        }

        // 清空多轮对话窗口
        function clearMultiTurnChatWindow() {
            const aiDiv = document.getElementById('aiResponse');
            aiDiv.innerHTML = `
                <div style="text-align: center; color: #666; padding: 40px;">
                    <p>📱 多轮对话模式</p>
                    <p>请在上方输入框中输入您的问题，点击"开始多轮对话"按钮开始聊天</p>
                    <p>支持富文本消息和连续对话</p>
                </div>
            `;
        }

        // 7. 历史记录接口测试函数
        async function getHistoryList() {
            try {
                log('正在获取历史记录列表...');
                const response = await fetch('http://localhost:5000/api/conversations', {
                    method: 'GET',
                    headers: getHeaders()
                });
                const data = await response.json();
                document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
                log('历史记录列表获取完成');
            } catch (error) {
                log('获取历史记录列表失败: ' + error.message);
                document.getElementById('historyResult').textContent = 'Error: ' + error.message;
            }
        }

        async function getHistoryStats() {
            try {
                log('正在获取历史记录统计信息...');
                const response = await fetch('http://localhost:5000/api/conversations/stats', {
                    method: 'GET',
                    headers: getHeaders()
                });
                const data = await response.json();
                document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
                log('历史记录统计信息获取完成');
            } catch (error) {
                log('获取历史记录统计信息失败: ' + error.message);
                document.getElementById('historyResult').textContent = 'Error: ' + error.message;
            }
        }

        async function getRecentHistory() {
            try {
                log('正在获取最近5条历史记录...');
                const response = await fetch('http://localhost:5000/api/conversations/recent?limit=5', {
                    method: 'GET',
                    headers: getHeaders()
                });
                const data = await response.json();
                document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
                log('最近历史记录获取完成');
            } catch (error) {
                log('获取最近历史记录失败: ' + error.message);
                document.getElementById('historyResult').textContent = 'Error: ' + error.message;
            }
        }

        async function getHistoryDetail() {
            const conversationId = document.getElementById('historyDetailId').value.trim();
            if (!conversationId) {
                alert('请输入对话ID');
                return;
            }
            
            try {
                log(`正在获取对话 ${conversationId} 的详情...`);
                const response = await fetch(`http://localhost:5000/api/conversations/${conversationId}`, {
                    method: 'GET',
                    headers: getHeaders()
                });
                const data = await response.json();
                document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
                log('对话详情获取完成');
            } catch (error) {
                log('获取对话详情失败: ' + error.message);
                document.getElementById('historyResult').textContent = 'Error: ' + error.message;
            }
        }

        async function deleteHistoryDetail() {
            const conversationId = document.getElementById('historyDetailId').value.trim();
            if (!conversationId) {
                alert('请输入对话ID');
                return;
            }
            
            if (!confirm(`确定要删除对话 ${conversationId} 吗？此操作无法撤销！`)) {
                return;
            }
            
            try {
                log(`正在删除对话 ${conversationId}...`);
                const response = await fetch(`http://localhost:5000/api/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                const data = await response.json();
                document.getElementById('historyResult').textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    log('对话删除成功');
                    // 清空输入框
                    document.getElementById('historyDetailId').value = '';
                } else {
                    log('对话删除失败: ' + data.message);
                }
            } catch (error) {
                log('删除对话失败: ' + error.message);
                document.getElementById('historyResult').textContent = 'Error: ' + error.message;
            }
        }


    </script>
</body>
</html>
    </script>
</body>
</html>
    </script>
</body>
</html>